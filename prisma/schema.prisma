generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  USER
  BUSINESS_OWNER
  ADMIN
}

enum BusinessStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum ListingType {
  SERVICE
  FOR_SALE
  HOUSING
  JOB
  COMMUNITY
}

enum ListingStatus {
  ACTIVE
  INACTIVE
  SOLD
  EXPIRED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  phone         String?
  role          UserRole  @default(USER)
  emailVerified Boolean   @default(false)
  phoneVerified Boolean   @default(false)
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  businesses    Business[]
  listings      Listing[]
  reviews       Review[]
  favorites     Favorite[]
  messages      Message[]
  reports       Report[]

  @@index([email])
}

model Business {
  id                String         @id @default(cuid())
  name              String
  description       String?
  category          String
  subcategory       String?
  address           String
  city              String
  state             String
  zipCode           String
  country           String         @default("USA")
  latitude          Float?
  longitude         Float?
  phone             String
  email             String?
  website           String?
  logo              String?
  coverImage        String?
  images            String[]

  // Business Details
  businessHours     Json?
  serviceAreas      String[]
  languages         String[]
  paymentMethods    String[]
  halalCertified    Boolean        @default(false)
  womenOwned        Boolean        @default(false)
  verified          Boolean        @default(false)
  featured          Boolean        @default(false)
  status            BusinessStatus @default(PENDING)

  // Metadata
  scrapedFrom       String?
  views             Int            @default(0)
  clicks            Int            @default(0)

  ownerId           String
  owner             User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  reviews           Review[]
  favorites         Favorite[]
  listings          Listing[]

  @@index([category, subcategory])
  @@index([city, state])
  @@index([latitude, longitude])
  @@index([status])
  @@index([ownerId])
}

model Listing {
  id                String         @id @default(cuid())
  title             String
  description       String
  type              ListingType
  category          String
  subcategory       String?
  price             Float?
  priceNegotiable   Boolean        @default(false)
  images            String[]

  // Location
  address           String?
  city              String
  state             String
  zipCode           String?
  latitude          Float?
  longitude         Float?

  // Details
  status            ListingStatus  @default(ACTIVE)
  featured          Boolean        @default(false)
  views             Int            @default(0)
  contactInfo       Json?

  userId            String
  user              User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId        String?
  business          Business?      @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  expiresAt         DateTime?

  @@index([type, category])
  @@index([city, state])
  @@index([status])
  @@index([userId])
  @@index([businessId])
}

model Review {
  id                String    @id @default(cuid())
  rating            Int
  title             String?
  comment           String
  images            String[]
  helpful           Int       @default(0)
  notHelpful        Int       @default(0)
  verified          Boolean   @default(false)

  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId        String
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  response          String?
  responseDate      DateTime?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([businessId])
  @@index([userId])
  @@index([rating])
}

model Favorite {
  id                String    @id @default(cuid())

  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  businessId        String
  business          Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)

  createdAt         DateTime  @default(now())

  @@unique([userId, businessId])
  @@index([userId])
  @@index([businessId])
}

model Message {
  id                String    @id @default(cuid())
  content           String
  read              Boolean   @default(false)

  senderId          String
  sender            User      @relation(fields: [senderId], references: [id], onDelete: Cascade)

  receiverId        String?
  recipientEmail    String?
  recipientPhone    String?

  createdAt         DateTime  @default(now())

  @@index([senderId])
  @@index([receiverId])
}

model Report {
  id                String    @id @default(cuid())
  reason            String
  description       String?
  status            String    @default("PENDING")

  reporterId        String
  reporter          User      @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  targetType        String
  targetId          String

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([reporterId])
  @@index([status])
  @@index([targetType, targetId])
}

model Category {
  id                String    @id @default(cuid())
  name              String    @unique
  slug              String    @unique
  description       String?
  icon              String?
  type              ListingType
  parentId          String?
  order             Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([type])
  @@index([slug])
}

model ScrapingSource {
  id                String    @id @default(cuid())
  name              String
  url               String    @unique
  selector          Json
  enabled           Boolean   @default(true)
  lastScraped       DateTime?
  scrapedCount      Int       @default(0)

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}
